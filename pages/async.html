<div class="container">
    <a href="#" class="back-button">← Назад к списку тем</a>
    
    <div class="page-header">
        <h1>⏳ Асинхронность</h1>
        <p>Promises, async/await, обработка ошибок, параллельные запросы и Event Loop - критически важные темы для Frontend разработчика</p>
    </div>

    <div class="content-section">
        <h2>Проблема асинхронности</h2>
        <p>JavaScript однопоточный. Для работы с асинхронными операциями (запросы к серверу, таймеры, файлы) используются колбэки, Promises и async/await.</p>
        
        <div class="code-block">
            <span class="code-block-title">Пример 1: Проблема Callback Hell</span>
            <pre><code><span class="comment">// Плохо: вложенные колбэки</span>
<span class="function">fetchUser</span>(<span class="variable">userId</span>, <span class="function">function</span>(<span class="variable">user</span>) {
    <span class="function">fetchPosts</span>(<span class="variable">user</span>.<span class="variable">id</span>, <span class="function">function</span>(<span class="variable">posts</span>) {
        <span class="function">fetchComments</span>(<span class="variable">posts</span>[<span class="number">0</span>].<span class="variable">id</span>, <span class="function">function</span>(<span class="variable">comments</span>) {
            <span class="comment">// Callback hell - сложно читать и поддерживать</span>
        });
    });
});</code></pre>
        </div>
    </div>

    <div class="content-section">
        <h2>Promises</h2>
        <p>Promise - объект, представляющий результат асинхронной операции. Может быть в состоянии: pending (ожидание), fulfilled (выполнено), rejected (отклонено).</p>
        
        <div class="code-block">
            <span class="code-block-title">Пример 2: Создание Promise</span>
            <pre><code><span class="keyword">const</span> <span class="variable">promise</span> = <span class="keyword">new</span> <span class="function">Promise</span>((<span class="variable">resolve</span>, <span class="variable">reject</span>) =&gt; {
    <span class="comment">// Асинхронная операция</span>
    <span class="function">setTimeout</span>(() =&gt; {
        <span class="keyword">const</span> <span class="variable">success</span> = <span class="keyword">true</span>;
        
        <span class="keyword">if</span> (<span class="variable">success</span>) {
            <span class="variable">resolve</span>(<span class="string">"Данные загружены"</span>);  <span class="comment">// Успех</span>
        } <span class="keyword">else</span> {
            <span class="variable">reject</span>(<span class="keyword">new</span> <span class="function">Error</span>(<span class="string">"Ошибка загрузки"</span>));  <span class="comment">// Ошибка</span>
        }
    }, <span class="number">1000</span>);
});

<span class="comment">// Использование</span>
<span class="variable">promise</span>
    .<span class="function">then</span>(<span class="variable">result</span> =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">result</span>);  <span class="comment">// "Данные загружены"</span>
    })
    .<span class="function">catch</span>(<span class="variable">error</span> =&gt; {
        <span class="function">console</span>.<span class="function">error</span>(<span class="variable">error</span>);
    });</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 3: Цепочка Promises</span>
            <pre><code><span class="comment">// Последовательное выполнение</span>
<span class="function">fetchUser</span>(<span class="variable">userId</span>)
    .<span class="function">then</span>(<span class="variable">user</span> =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">user</span>);
        <span class="keyword">return</span> <span class="function">fetchPosts</span>(<span class="variable">user</span>.<span class="variable">id</span>);  <span class="comment">// Возвращаем новый Promise</span>
    })
    .<span class="function">then</span>(<span class="variable">posts</span> =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">posts</span>);
        <span class="keyword">return</span> <span class="function">fetchComments</span>(<span class="variable">posts</span>[<span class="number">0</span>].<span class="variable">id</span>);
    })
    .<span class="function">then</span>(<span class="variable">comments</span> =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">comments</span>);
    })
    .<span class="function">catch</span>(<span class="variable">error</span> =&gt; {
        <span class="comment">// Обработка ошибок из любой цепочки</span>
        <span class="function">console</span>.<span class="function">error</span>(<span class="string">"Ошибка:"</span>, <span class="variable">error</span>);
    })
    .<span class="function">finally</span>(() =&gt; {
        <span class="comment">// Выполнится всегда</span>
        <span class="function">console</span>.<span class="function">log</span>(<span class="string">"Завершено"</span>);
    });</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 4: Promise.all - параллельное выполнение</span>
            <pre><code><span class="comment">// Ждет выполнения всех Promises</span>
<span class="keyword">const</span> <span class="variable">promise1</span> = <span class="function">fetchUser</span>(<span class="number">1</span>);
<span class="keyword">const</span> <span class="variable">promise2</span> = <span class="function">fetchUser</span>(<span class="number">2</span>);
<span class="keyword">const</span> <span class="variable">promise3</span> = <span class="function">fetchUser</span>(<span class="number">3</span>);

<span class="function">Promise</span>.<span class="function">all</span>([<span class="variable">promise1</span>, <span class="variable">promise2</span>, <span class="variable">promise3</span>])
    .<span class="function">then</span>(([<span class="variable">user1</span>, <span class="variable">user2</span>, <span class="variable">user3</span>]) =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">user1</span>, <span class="variable">user2</span>, <span class="variable">user3</span>);
    })
    .<span class="function">catch</span>(<span class="variable">error</span> =&gt; {
        <span class="comment">// Если хотя бы один Promise отклонен</span>
        <span class="function">console</span>.<span class="function">error</span>(<span class="variable">error</span>);
    });</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 5: Promise.allSettled - все результаты</span>
            <pre><code><span class="comment">// Ждет все Promises, даже если некоторые отклонены</span>
<span class="function">Promise</span>.<span class="function">allSettled</span>([<span class="variable">promise1</span>, <span class="variable">promise2</span>, <span class="variable">promise3</span>])
    .<span class="function">then</span>(<span class="variable">results</span> =&gt; {
        <span class="variable">results</span>.<span class="function">forEach</span>((<span class="variable">result</span>, <span class="variable">index</span>) =&gt; {
            <span class="keyword">if</span> (<span class="variable">result</span>.<span class="variable">status</span> === <span class="string">"fulfilled"</span>) {
                <span class="function">console</span>.<span class="function">log</span>(<span class="string">`Promise ${index}:`</span>, <span class="variable">result</span>.<span class="variable">value</span>);
            } <span class="keyword">else</span> {
                <span class="function">console</span>.<span class="function">error</span>(<span class="string">`Promise ${index} failed:`</span>, <span class="variable">result</span>.<span class="variable">reason</span>);
            }
        });
    });</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 6: Promise.race - первый выполненный</span>
            <pre><code><span class="comment">// Возвращает первый выполненный Promise (успешный или нет)</span>
<span class="keyword">const</span> <span class="variable">fastPromise</span> = <span class="function">fetchFromCache</span>();
<span class="keyword">const</span> <span class="variable">slowPromise</span> = <span class="function">fetchFromServer</span>();

<span class="function">Promise</span>.<span class="function">race</span>([<span class="variable">fastPromise</span>, <span class="variable">slowPromise</span>])
    .<span class="function">then</span>(<span class="variable">result</span> =&gt; {
        <span class="function">console</span>.<span class="function">log</span>(<span class="string">"Первый результат:"</span>, <span class="variable">result</span>);
    });</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 7: Promise.resolve и Promise.reject</span>
            <pre><code><span class="comment">// Создание уже выполненного Promise</span>
<span class="keyword">const</span> <span class="variable">resolved</span> = <span class="function">Promise</span>.<span class="function">resolve</span>(<span class="string">"Готово"</span>);
<span class="variable">resolved</span>.<span class="function">then</span>(<span class="variable">value</span> =&gt; <span class="function">console</span>.<span class="function">log</span>(<span class="variable">value</span>));  <span class="comment">// "Готово"</span>

<span class="keyword">const</span> <span class="variable">rejected</span> = <span class="function">Promise</span>.<span class="function">reject</span>(<span class="keyword">new</span> <span class="function">Error</span>(<span class="string">"Ошибка"</span>));
<span class="variable">rejected</span>.<span class="function">catch</span>(<span class="variable">error</span> =&gt; <span class="function">console</span>.<span class="function">error</span>(<span class="variable">error</span>));</code></pre>
        </div>
    </div>

    <div class="content-section">
        <h2>async/await</h2>
        <p>Современный синтаксис для работы с асинхронным кодом. Делает код более читаемым и похожим на синхронный.</p>
        
        <div class="code-block">
            <span class="code-block-title">Пример 8: Базовый async/await</span>
            <pre><code><span class="comment">// Функция с async всегда возвращает Promise</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchData</span>() {
    <span class="keyword">try</span> {
        <span class="comment">// await ждет выполнения Promise</span>
        <span class="keyword">const</span> <span class="variable">user</span> = <span class="keyword">await</span> <span class="function">fetchUser</span>(<span class="number">1</span>);
        <span class="keyword">const</span> <span class="variable">posts</span> = <span class="keyword">await</span> <span class="function">fetchPosts</span>(<span class="variable">user</span>.<span class="variable">id</span>);
        <span class="keyword">const</span> <span class="variable">comments</span> = <span class="keyword">await</span> <span class="function">fetchComments</span>(<span class="variable">posts</span>[<span class="number">0</span>].<span class="variable">id</span>);
        
        <span class="function">console</span>.<span class="function">log</span>(<span class="variable">user</span>, <span class="variable">posts</span>, <span class="variable">comments</span>);
        <span class="keyword">return</span> <span class="variable">comments</span>;
    } <span class="keyword">catch</span> (<span class="variable">error</span>) {
        <span class="function">console</span>.<span class="function">error</span>(<span class="string">"Ошибка:"</span>, <span class="variable">error</span>);
        <span class="keyword">throw</span> <span class="variable">error</span>;  <span class="comment">// Пробрасываем ошибку дальше</span>
    } <span class="keyword">finally</span> {
        <span class="function">console</span>.<span class="function">log</span>(<span class="string">"Завершено"</span>);
    }
}

<span class="comment">// Вызов</span>
<span class="function">fetchData</span>().<span class="function">then</span>(<span class="variable">comments</span> =&gt; {
    <span class="function">console</span>.<span class="function">log</span>(<span class="string">"Получено комментариев:"</span>, <span class="variable">comments</span>.<span class="variable">length</span>);
});</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 9: Параллельное выполнение с await</span>
            <pre><code><span class="comment">// Плохо: последовательное выполнение (медленно)</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchSequentially</span>() {
    <span class="keyword">const</span> <span class="variable">user1</span> = <span class="keyword">await</span> <span class="function">fetchUser</span>(<span class="number">1</span>);
    <span class="keyword">const</span> <span class="variable">user2</span> = <span class="keyword">await</span> <span class="function">fetchUser</span>(<span class="number">2</span>);
    <span class="keyword">const</span> <span class="variable">user3</span> = <span class="keyword">await</span> <span class="function">fetchUser</span>(<span class="number">3</span>);
    <span class="comment">// Время: 3 секунды (если каждый запрос 1 сек)</span>
}

<span class="comment">// Хорошо: параллельное выполнение</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchInParallel</span>() {
    <span class="comment">// Запускаем все запросы одновременно</span>
    <span class="keyword">const</span> [<span class="variable">user1</span>, <span class="variable">user2</span>, <span class="variable">user3</span>] = <span class="keyword">await</span> <span class="function">Promise</span>.<span class="function">all</span>([
        <span class="function">fetchUser</span>(<span class="number">1</span>),
        <span class="function">fetchUser</span>(<span class="number">2</span>),
        <span class="function">fetchUser</span>(<span class="number">3</span>)
    ]);
    <span class="comment">// Время: 1 секунда!</span>
    
    <span class="keyword">return</span> { <span class="variable">user1</span>, <span class="variable">user2</span>, <span class="variable">user3</span> };
}

<span class="comment">// Или с allSettled</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchSafely</span>() {
    <span class="keyword">const</span> <span class="variable">results</span> = <span class="keyword">await</span> <span class="function">Promise</span>.<span class="function">allSettled</span>([
        <span class="function">fetchUser</span>(<span class="number">1</span>),
        <span class="function">fetchUser</span>(<span class="number">2</span>),
        <span class="function">fetchUser</span>(<span class="number">999</span>)  <span class="comment">// Может быть ошибка</span>
    ]);
    
    <span class="variable">results</span>.<span class="function">forEach</span>(<span class="variable">result</span> =&gt; {
        <span class="keyword">if</span> (<span class="variable">result</span>.<span class="variable">status</span> === <span class="string">"fulfilled"</span>) {
            <span class="function">console</span>.<span class="function">log</span>(<span class="variable">result</span>.<span class="variable">value</span>);
        }
    });
}</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 10: Стрелочные async функции</span>
            <pre><code><span class="keyword">const</span> <span class="variable">fetchData</span> = <span class="keyword">async</span> () =&gt; {
    <span class="keyword">const</span> <span class="variable">data</span> = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">"/api/data"</span>);
    <span class="keyword">return</span> <span class="variable">data</span>.<span class="function">json</span>();
};

<span class="comment">// В методах объекта</span>
<span class="keyword">const</span> <span class="variable">api</span> = {
    <span class="keyword">async</span> <span class="function">getUser</span>(<span class="variable">id</span>) {
        <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">`/api/users/${id}`</span>);
        <span class="keyword">return</span> <span class="variable">response</span>.<span class="function">json</span>();
    }
};</code></pre>
        </div>
    </div>

    <div class="content-section">
        <h2>Event Loop</h2>
        <p>Event Loop - механизм, который позволяет JavaScript выполнять асинхронный код. Важно понимать, как работает очередь событий.</p>
        
        <div class="code-block">
            <span class="code-block-title">Пример 11: Порядок выполнения</span>
            <pre><code><span class="function">console</span>.<span class="function">log</span>(<span class="string">"1. Синхронный код"</span>);

<span class="function">setTimeout</span>(() =&gt; {
    <span class="function">console</span>.<span class="function">log</span>(<span class="string">"4. setTimeout (макрозадача)"</span>);
}, <span class="number">0</span>);

<span class="function">Promise</span>.<span class="function">resolve</span>().<span class="function">then</span>(() =&gt; {
    <span class="function">console</span>.<span class="function">log</span>(<span class="string">"3. Promise (микрозадача)"</span>);
});

<span class="function">console</span>.<span class="function">log</span>(<span class="string">"2. Синхронный код"</span>);

<span class="comment">// Вывод:
// 1. Синхронный код
// 2. Синхронный код
// 3. Promise (микрозадача) - выполняется перед макрозадачами!
// 4. setTimeout (макрозадача)</span></code></pre>
        </div>

        <div class="note">
            <strong>Важно:</strong> Микрозадачи (Promises, queueMicrotask) выполняются перед макрозадачами (setTimeout, setInterval, события DOM). Это важно понимать для правильной работы с асинхронным кодом.
        </div>
    </div>

    <div class="content-section">
        <h2>Обработка ошибок</h2>
        
        <div class="code-block">
            <span class="code-block-title">Пример 12: Обработка ошибок в async/await</span>
            <pre><code><span class="comment">// Способ 1: try/catch</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">safeFetch</span>() {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">"/api/data"</span>);
        <span class="keyword">if</span> (!<span class="variable">response</span>.<span class="variable">ok</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="function">Error</span>(<span class="string">`HTTP ${response.status}`</span>);
        }
        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable">response</span>.<span class="function">json</span>();
    } <span class="keyword">catch</span> (<span class="variable">error</span>) {
        <span class="function">console</span>.<span class="function">error</span>(<span class="string">"Ошибка:"</span>, <span class="variable">error</span>);
        <span class="keyword">return</span> <span class="keyword">null</span>;  <span class="comment">// Возвращаем значение по умолчанию</span>
    }
}

<span class="comment">// Способ 2: catch в Promise</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">safeFetch2</span>() {
    <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">"/api/data"</span>)
        .<span class="function">catch</span>(<span class="variable">error</span> =&gt; {
            <span class="function">console</span>.<span class="function">error</span>(<span class="variable">error</span>);
            <span class="keyword">return</span> <span class="keyword">null</span>;
        });
    
    <span class="keyword">return</span> <span class="variable">response</span> ? <span class="variable">response</span>.<span class="function">json</span>() : <span class="keyword">null</span>;
}</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 13: Вспомогательная функция для обработки ошибок</span>
            <pre><code><span class="comment">// Утилита для безопасной обработки Promise</span>
<span class="function">function</span> <span class="function">to</span>(<span class="variable">promise</span>) {
    <span class="keyword">return</span> <span class="variable">promise</span>
        .<span class="function">then</span>(<span class="variable">data</span> =&gt; [<span class="keyword">null</span>, <span class="variable">data</span>])
        .<span class="function">catch</span>(<span class="variable">error</span> =&gt; [<span class="variable">error</span>, <span class="keyword">null</span>]);
}

<span class="comment">// Использование</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchUser</span>(<span class="variable">id</span>) {
    <span class="keyword">const</span> [<span class="variable">error</span>, <span class="variable">user</span>] = <span class="keyword">await</span> <span class="function">to</span>(<span class="function">fetch</span>(<span class="string">`/api/users/${id}`</span>).<span class="function">then</span>(<span class="variable">r</span> =&gt; <span class="variable">r</span>.<span class="function">json</span>()));
    
    <span class="keyword">if</span> (<span class="variable">error</span>) {
        <span class="function">console</span>.<span class="function">error</span>(<span class="variable">error</span>);
        <span class="keyword">return</span> <span class="keyword">null</span>;
    }
    
    <span class="keyword">return</span> <span class="variable">user</span>;
}</code></pre>
        </div>
    </div>

    <div class="content-section">
        <h2>Практические примеры</h2>
        
        <div class="code-block">
            <span class="code-block-title">Пример 14: Загрузка с таймаутом</span>
            <pre><code><span class="function">function</span> <span class="function">fetchWithTimeout</span>(<span class="variable">url</span>, <span class="variable">timeout</span> = <span class="number">5000</span>) {
    <span class="keyword">return</span> <span class="function">Promise</span>.<span class="function">race</span>([
        <span class="function">fetch</span>(<span class="variable">url</span>),
        <span class="keyword">new</span> <span class="function">Promise</span>((_, <span class="variable">reject</span>) =&gt;
            <span class="function">setTimeout</span>(() =&gt; <span class="variable">reject</span>(<span class="keyword">new</span> <span class="function">Error</span>(<span class="string">"Timeout"</span>)), <span class="variable">timeout</span>)
        )
    ]);
}

<span class="comment">// Использование</span>
<span class="keyword">async</span> <span class="function">function</span> <span class="function">loadData</span>() {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="function">fetchWithTimeout</span>(<span class="string">"/api/data"</span>, <span class="number">3000</span>);
        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable">response</span>.<span class="function">json</span>();
    } <span class="keyword">catch</span> (<span class="variable">error</span>) {
        <span class="keyword">if</span> (<span class="variable">error</span>.<span class="variable">message</span> === <span class="string">"Timeout"</span>) {
            <span class="function">console</span>.<span class="function">error</span>(<span class="string">"Запрос превысил время ожидания"</span>);
        }
        <span class="keyword">throw</span> <span class="variable">error</span>;
    }
}</code></pre>
        </div>

        <div class="code-block">
            <span class="code-block-title">Пример 15: Повторные попытки</span>
            <pre><code><span class="keyword">async</span> <span class="function">function</span> <span class="function">fetchWithRetry</span>(<span class="variable">url</span>, <span class="variable">retries</span> = <span class="number">3</span>, <span class="variable">delay</span> = <span class="number">1000</span>) {
    <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">i</span> = <span class="number">0</span>; <span class="variable">i</span> &lt; <span class="variable">retries</span>; <span class="variable">i</span>++) {
        <span class="keyword">try</span> {
            <span class="keyword">const</span> <span class="variable">response</span> = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="variable">url</span>);
            <span class="keyword">if</span> (<span class="variable">response</span>.<span class="variable">ok</span>) {
                <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable">response</span>.<span class="function">json</span>();
            }
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="function">Error</span>(<span class="string">`HTTP ${response.status}`</span>);
        } <span class="keyword">catch</span> (<span class="variable">error</span>) {
            <span class="keyword">if</span> (<span class="variable">i</span> === <span class="variable">retries</span> - <span class="number">1</span>) {
                <span class="keyword">throw</span> <span class="variable">error</span>;  <span class="comment">// Последняя попытка</span>
            }
            <span class="function">console</span>.<span class="function">log</span>(<span class="string">`Попытка ${i + 1} не удалась, повтор через ${delay}ms`</span>);
            <span class="keyword">await</span> <span class="keyword">new</span> <span class="function">Promise</span>(<span class="variable">resolve</span> =&gt; <span class="function">setTimeout</span>(<span class="variable">resolve</span>, <span class="variable">delay</span>));
        }
    }
}</code></pre>
        </div>
    </div>

    <div class="tip">
        <strong>Совет:</strong> Всегда обрабатывайте ошибки в асинхронном коде. Используйте try/catch с async/await или .catch() с Promises. Не забывайте про параллельное выполнение - используйте Promise.all() вместо последовательных await.
    </div>
</div>

